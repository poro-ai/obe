<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OBE-Project｜內容編輯器</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text y='.9em' font-size='24'>✎</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    :root {
      --bg: #faf8f5;
      --card: #fffef9;
      --border: #e8e4dc;
      --text: #2c2825;
      --muted: #6b6560;
      --accent: #5c4a3a;
      --accent-hover: #4a3c2f;
    }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 720px;
      margin: 0 auto;
      padding: 1.5rem 1rem 3rem;
      min-height: 100vh;
    }
    h1 {
      font-family: 'Noto Serif TC', serif;
      font-weight: 600;
      font-size: 1.5rem;
      margin: 0 0 0.5rem;
      color: var(--accent);
    }
    .sub {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 1.5rem;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .toolbar button, .toolbar a {
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-family: inherit;
    }
    .toolbar button:hover, .toolbar a:hover {
      background: var(--border);
    }
    .toolbar button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .toolbar button.primary:hover {
      background: var(--accent-hover);
    }
    .load-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .load-panel textarea {
      width: 100%;
      min-height: 120px;
      padding: 0.6rem;
      font-family: monospace;
      font-size: 0.8rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      resize: vertical;
      margin-bottom: 0.5rem;
    }
    .page-section {
      margin-bottom: 2rem;
    }
    .page-title {
      font-family: 'Noto Serif TC', serif;
      font-size: 1rem;
      color: var(--muted);
      margin-bottom: 0.75rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid var(--border);
    }
    .block {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: grab;
      transition: box-shadow 0.15s;
    }
    .block:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .block.dragging { opacity: 0.6; cursor: grabbing; }
    .block.drag-over { border-color: var(--accent); background: #faf6f0; }
    .block-header {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .block img.preview {
      max-width: 100%;
      max-height: 280px;
      display: block;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    .block .desc-input {
      width: 100%;
      padding: 0.5rem;
      font-size: 0.9rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-top: 0.25rem;
      font-family: inherit;
    }
    .block .text-content {
      width: 100%;
      min-height: 80px;
      padding: 0.6rem;
      font-size: 0.95rem;
      line-height: 1.5;
      border: 1px solid var(--border);
      border-radius: 4px;
      resize: vertical;
      font-family: inherit;
    }
    .block .text-content:focus, .block .desc-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 3rem 1rem;
    }
    .empty-state p { margin: 0.5rem 0; }
    .gas-url-wrap {
      margin-bottom: 1rem;
    }
    .gas-url-wrap label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 0.25rem; }
    .gas-url-wrap input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .msg { font-size: 0.9rem; margin-top: 0.5rem; }
    .msg.ok { color: #2d6a2d; }
    .msg.err { color: #b33; }
    @media (max-width: 640px) {
      body { padding: 1rem 0.75rem; }
      .toolbar { flex-direction: column; }
      .toolbar button, .toolbar a { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>內容編輯器</h1>
  <p class="sub">載入 GCF 解析結果，以內容塊編輯後匯出至 Google Sheets。</p>

  <div class="toolbar">
    <button type="button" id="btnLoadStorage">從上次解析結果載入</button>
    <button type="button" id="btnLoadPaste">從貼上 JSON 載入</button>
    <button type="button" id="btnExport" class="primary" disabled>匯出／儲存至 Google Sheets</button>
    <button type="button" id="btnInsertSlides" class="primary" disabled style="display: none;">插入至 Google 簡報</button>
    <a id="backLink" href="index.html">← 返回上傳頁</a>
  </div>
  <p class="sub" id="slidesLinkHint" style="display: none;">已連結簡報，載入內容後可點「插入至 Google 簡報」將選取內容插入該簡報。</p>

  <div class="load-panel" id="loadPanel" style="display: none;">
    <label>貼上解析結果 JSON（含 <code>pages</code> 的物件或 <code>pages</code> 陣列）：</label>
    <textarea id="pasteArea" placeholder='{"pages": [{"page": 1, "elements": [...]}]}'></textarea>
    <button type="button" id="btnPasteGo">載入</button>
  </div>

  <div class="gas-url-wrap" id="gasUrlWrap" style="display: none;">
    <label>GAS Web App 網址（用於匯出）：</label>
    <input type="url" id="gasUrl" placeholder="https://script.google.com/..." />
  </div>

  <p class="msg" id="msg"></p>

  <div id="editor"></div>

  <script>
(function () {
  var EDITOR_STORAGE_KEY = 'obe_parse_result';
  var GAS_URL_KEY = 'obe_editor_gas_url';

  var btnLoadStorage = document.getElementById('btnLoadStorage');
  var btnLoadPaste = document.getElementById('btnLoadPaste');
  var loadPanel = document.getElementById('loadPanel');
  var pasteArea = document.getElementById('pasteArea');
  var btnPasteGo = document.getElementById('btnPasteGo');
  var btnExport = document.getElementById('btnExport');
  var gasUrlWrap = document.getElementById('gasUrlWrap');
  var gasUrl = document.getElementById('gasUrl');
  var msg = document.getElementById('msg');
  var editor = document.getElementById('editor');

  var state = { pages: [] };
  var urlPresentationId = null;
  var urlGasUrl = null;
  var urlToken = null;

  (function readUrlParams() {
    var params = new URLSearchParams(location.search);
    urlPresentationId = params.get('presentationId') || null;
    urlGasUrl = params.get('gasUrl') || null;
    urlToken = params.get('token') || null;
    if (urlGasUrl) {
      gasUrl.value = urlGasUrl;
      localStorage.setItem(GAS_URL_KEY, urlGasUrl);
    }
    if (urlPresentationId) {
      document.getElementById('slidesLinkHint').style.display = 'block';
      var btnInsert = document.getElementById('btnInsertSlides');
      if (btnInsert) btnInsert.style.display = 'inline-block';
      var backLink = document.getElementById('backLink');
      if (backLink) {
        backLink.href = 'https://docs.google.com/presentation/d/' + urlPresentationId + '/edit';
        backLink.textContent = '← 返回 Google 簡報';
      }
    }
  })();

  function showMsg(text, isError) {
    msg.textContent = text || '';
    msg.className = 'msg' + (text ? (isError ? ' err' : ' ok') : '');
  }

  function normalizePages(data) {
    var pages = Array.isArray(data) ? data : (data && data.pages);
    if (!pages || !Array.isArray(pages)) return [];
    return pages.map(function (p) {
      var pageNum = p.page != null ? p.page : (p.page_number != null ? p.page_number : 1);
      var elements;
      if (p.elements && Array.isArray(p.elements)) {
        elements = p.elements.map(function (e) {
          return {
            type: (e.type === 'image' ? 'image' : 'text'),
            content: (e.content || '').toString(),
            description: (e.description || '').toString()
          };
        });
      } else {
        /* 舊格式：group_id / visual_summary / associated_text / page_number → 單一文字塊 */
        elements = [{
          type: 'text',
          content: (p.associated_text || '').toString(),
          description: (p.visual_summary || '').toString()
        }];
      }
      return { page: pageNum, elements: elements };
    });
  }

  function loadFromStorage() {
    try {
      var raw = sessionStorage.getItem(EDITOR_STORAGE_KEY);
      if (!raw) {
        showMsg('尚無上次解析結果，請先在上傳頁完成解析。', true);
        return;
      }
      var data = JSON.parse(raw);
      state.pages = normalizePages(data.pages ? data : { pages: data });
      if (state.pages.length === 0) {
        showMsg('儲存內容沒有有效的 pages 陣列。', true);
        return;
      }
      render();
      showMsg('已從上次解析結果載入 ' + state.pages.length + ' 頁。');
      gasUrlWrap.style.display = 'block';
      var savedUrl = localStorage.getItem(GAS_URL_KEY);
      if (savedUrl) gasUrl.value = savedUrl;
    } catch (e) {
      showMsg('載入失敗：' + e.message, true);
    }
  }

  function loadFromPaste() {
    loadPanel.style.display = loadPanel.style.display === 'none' ? 'block' : 'none';
    if (loadPanel.style.display === 'block') pasteArea.focus();
  }

  function doPasteGo() {
    var raw = (pasteArea.value || '').trim();
    if (!raw) {
      showMsg('請貼上 JSON 內容。', true);
      return;
    }
    try {
      var data = JSON.parse(raw);
      state.pages = normalizePages(data.pages ? data : data);
      if (state.pages.length === 0) {
        showMsg('JSON 中沒有有效的 pages 陣列。', true);
        return;
      }
      loadPanel.style.display = 'none';
      pasteArea.value = '';
      render();
      showMsg('已載入 ' + state.pages.length + ' 頁。');
      gasUrlWrap.style.display = 'block';
      var savedUrl = localStorage.getItem(GAS_URL_KEY);
      if (savedUrl) gasUrl.value = savedUrl;
    } catch (e) {
      showMsg('JSON 解析失敗：' + e.message, true);
    }
  }

  function render() {
    btnExport.disabled = state.pages.length === 0;
    var btnInsert = document.getElementById('btnInsertSlides');
    if (btnInsert) btnInsert.disabled = !urlPresentationId || state.pages.length === 0;
    if (state.pages.length === 0) {
      editor.innerHTML = '<div class="empty-state"><p>尚無內容。</p><p>請從「上次解析結果」載入，或貼上 JSON 後載入。</p></div>';
      return;
    }
    var html = '';
    for (var pi = 0; pi < state.pages.length; pi++) {
      var pg = state.pages[pi];
      html += '<div class="page-section" data-page-index="' + pi + '">';
      html += '<div class="page-title">第 ' + (pg.page || (pi + 1)) + ' 頁</div>';
      for (var ei = 0; ei < pg.elements.length; ei++) {
        var el = pg.elements[ei];
        var isImg = el.type === 'image';
        html += '<div class="block" draggable="true" data-page-index="' + pi + '" data-element-index="' + ei + '">';
        html += '<div class="block-header">' + (isImg ? '圖片' : '文字') + '</div>';
        if (isImg) {
          var src = el.content && (el.content.indexOf('data:') === 0 || el.content.indexOf('http') === 0) ? el.content : '';
          if (src) html += '<img class="preview" src="' + src.replace(/"/g, '&quot;') + '" alt="" />';
          else html += '<div class="empty-state" style="padding:1rem;"><p>無預覽</p></div>';
          html += '<input type="text" class="desc-input" placeholder="圖片描述" value="' + (el.description || '').replace(/"/g, '&quot;') + '" data-page="' + pi + '" data-el="' + ei + '" data-field="description" />';
        } else {
          html += '<textarea class="text-content" data-page="' + pi + '" data-el="' + ei + '" data-field="content">' + (el.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</textarea>';
        }
        html += '</div>';
      }
      html += '</div>';
    }
    editor.innerHTML = html;
    bindBlockEvents();
  }

  function bindBlockEvents() {
    var blocks = editor.querySelectorAll('.block');
    blocks.forEach(function (block) {
      block.addEventListener('dragstart', onDragStart);
      block.addEventListener('dragend', onDragEnd);
      block.addEventListener('dragover', onDragOver);
      block.addEventListener('drop', onDrop);
      block.addEventListener('dragleave', onDragLeave);
    });
    editor.querySelectorAll('.desc-input, .text-content').forEach(function (el) {
      el.addEventListener('input', onFieldInput);
      el.addEventListener('change', onFieldInput);
    });
  }

  function onFieldInput(e) {
    var t = e.target;
    var pi = parseInt(t.getAttribute('data-page'), 10);
    var ei = parseInt(t.getAttribute('data-el'), 10);
    var field = t.getAttribute('data-field');
    if (isNaN(pi) || isNaN(ei) || !state.pages[pi] || !state.pages[pi].elements[ei]) return;
    state.pages[pi].elements[ei][field] = t.value;
  }

  var dragged = null;
  function onDragStart(e) {
    dragged = e.target.closest('.block');
    if (dragged) dragged.classList.add('dragging');
    e.dataTransfer.setData('text/plain', '');
    e.dataTransfer.effectAllowed = 'move';
  }
  function onDragEnd(e) {
    if (dragged) dragged.classList.remove('dragging');
    dragged = null;
  }
  function onDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    var block = e.target.closest('.block');
    if (block && block !== dragged) block.classList.add('drag-over');
  }
  function onDragLeave(e) {
    var block = e.target.closest('.block');
    if (block) block.classList.remove('drag-over');
  }
  function onDrop(e) {
    e.preventDefault();
    var toBlock = e.target.closest('.block');
    if (!toBlock || !dragged || toBlock === dragged) {
      editor.querySelectorAll('.block').forEach(function (b) { b.classList.remove('drag-over'); });
      return;
    }
    toBlock.classList.remove('drag-over');
    var fromPi = parseInt(dragged.getAttribute('data-page-index'), 10);
    var fromEi = parseInt(dragged.getAttribute('data-element-index'), 10);
    var toPi = parseInt(toBlock.getAttribute('data-page-index'), 10);
    var toEi = parseInt(toBlock.getAttribute('data-element-index'), 10);
    if (fromPi === toPi && fromEi === toEi) return;
    var fromEl = state.pages[fromPi].elements[fromEi];
    state.pages[fromPi].elements.splice(fromEi, 1);
    if (fromPi === toPi && toEi > fromEi) toEi--;
    state.pages[toPi].elements.splice(toEi, 0, fromEl);
    render();
    showMsg('已移動內容塊。');
  }

  function collectState() {
    var inputs = editor.querySelectorAll('.desc-input, .text-content');
    inputs.forEach(function (el) {
      var pi = parseInt(el.getAttribute('data-page'), 10);
      var ei = parseInt(el.getAttribute('data-el'), 10);
      var field = el.getAttribute('data-field');
      if (!isNaN(pi) && !isNaN(ei) && state.pages[pi] && state.pages[pi].elements[ei])
        state.pages[pi].elements[ei][field] = el.value;
    });
    return state.pages;
  }

  function exportToSheets() {
    var url = (gasUrl.value || '').trim();
    if (!url) {
      showMsg('請輸入 GAS Web App 網址。', true);
      return;
    }
    localStorage.setItem(GAS_URL_KEY, url);
    collectState();
    var payload = { action: 'saveToSheets', pages: state.pages };
    showMsg('匯出中…');
    btnExport.disabled = true;
    fetch(url, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    })
      .then(function (res) { return res.text(); })
      .then(function (text) {
        try {
          var data = JSON.parse(text);
          if (data.success && data.sheetUrl) {
            showMsg('已匯出至 Google Sheets：' + data.sheetUrl);
            window.open(data.sheetUrl, '_blank');
          } else {
            showMsg(data.error || '匯出失敗', true);
          }
        } catch (e) {
          showMsg('回應解析失敗', true);
        }
        btnExport.disabled = false;
      })
      .catch(function (err) {
        showMsg('請求失敗（網路或 CORS）', true);
        btnExport.disabled = false;
      });
  }

  btnLoadStorage.addEventListener('click', loadFromStorage);
  btnLoadPaste.addEventListener('click', loadFromPaste);
  btnPasteGo.addEventListener('click', doPasteGo);
  btnExport.addEventListener('click', exportToSheets);
  var btnInsertSlides = document.getElementById('btnInsertSlides');
  if (btnInsertSlides) btnInsertSlides.addEventListener('click', insertToSlides);

  function loadFromToken() {
    if (!urlToken) return;
    var baseUrl = (gasUrl.value || urlGasUrl || '').trim();
    if (!baseUrl) {
      showMsg('無法從側邊欄帶入結果：缺少 GAS Web App 網址。請從 Slides 側邊欄點「在瀏覽器開啟編輯器」進入。', true);
      return;
    }
    var url = baseUrl + (baseUrl.indexOf('?') >= 0 ? '&' : '?') + 'action=getParseResult&token=' + encodeURIComponent(urlToken);
    showMsg('正在從側邊欄載入解析結果…');
    fetch(url, { method: 'GET', mode: 'cors' })
      .then(function (res) { return res.text(); })
      .then(function (text) {
        try {
          var data = JSON.parse(text);
          if (data.error) {
            showMsg('Token 已過期或無效，請在側邊欄重新解析後再點「在瀏覽器開啟編輯器」。', true);
            return;
          }
          state.pages = normalizePages(Array.isArray(data) ? data : (data.pages ? data : { pages: data }));
          if (state.pages.length === 0) {
            showMsg('取得的內容沒有有效的 pages。', true);
            return;
          }
          render();
          gasUrlWrap.style.display = 'block';
          showMsg('已從側邊欄載入 ' + state.pages.length + ' 頁。');
        } catch (e) {
          showMsg('載入失敗：' + e.message, true);
        }
      })
      .catch(function (err) {
        showMsg('請求失敗（請確認 GAS Web App 網址與 CORS）。', true);
      });
  }

  if (urlToken && (gasUrl.value || urlGasUrl)) {
    loadFromToken();
  } else if (sessionStorage.getItem(EDITOR_STORAGE_KEY)) {
    loadFromStorage();
  } else if (urlPresentationId) {
    gasUrlWrap.style.display = 'block';
  }
})();
  </script>
</body>
</html>
