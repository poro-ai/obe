<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI è§£æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* å´é‚Šæ¬„å¯¬åº¦é©é…ï¼Œé€²åº¦æ¢éæ¸¡ */
    #progress-bar { transition: width 0.25s ease-out; }
    .btn-upload { background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; }
    .btn-upload:hover { background: linear-gradient(180deg, #e9ecef 0%, #dee2e6 100%); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 text-sm antialiased min-h-screen flex flex-col">
  <div class="p-3 flex flex-col gap-3 flex-1 min-w-0">
    <!-- é ‚éƒ¨ï¼šéš±è— file input + ä¸Šå‚³ PDF æŒ‰éˆ• -->
    <input type="file" id="file-input" accept=".pdf,application/pdf" class="hidden" />
    <button type="button" id="btn-upload" class="btn-upload w-full py-2.5 px-3 rounded-lg font-medium text-gray-700 shadow-sm border border-gray-200 hover:shadow">
      ğŸ“„ ä¸Šå‚³ PDF
    </button>

    <!-- é€²åº¦å€ï¼šå‹•æ…‹é€²åº¦æ¢èˆ‡ç‹€æ…‹æ–‡å­— -->
    <div id="progress-area" class="hidden rounded-lg overflow-hidden bg-gray-200 border border-gray-200">
      <div id="progress-bar" class="h-2 bg-blue-500 w-0" style="max-width: 100%;"></div>
      <p id="progress-text" class="px-2 py-1.5 text-gray-600 text-xs">æº–å‚™ä¸­...</p>
    </div>

    <!-- è§£æçµæœå®¹å™¨ -->
    <div class="flex-1 min-h-0 flex flex-col rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden">
      <div class="px-2 py-1.5 bg-gray-100 border-b border-gray-200 text-gray-600 font-medium text-xs">
        è§£æçµæœ
      </div>
      <div id="content-list" class="flex-1 overflow-y-auto p-2 space-y-2 min-h-[120px]">
        <p class="text-gray-400 text-xs py-4 text-center">ä¸Šå‚³ PDF å¾Œå°‡åœ¨æ­¤é¡¯ç¤º AI è§£æçµæœ</p>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var fileInput = document.getElementById('file-input');
      var btnUpload = document.getElementById('btn-upload');
      var progressArea = document.getElementById('progress-area');
      var progressBar = document.getElementById('progress-bar');
      var progressText = document.getElementById('progress-text');
      var contentList = document.getElementById('content-list');

      function setProgress(percent, text) {
        progressArea.classList.remove('hidden');
        progressBar.style.width = (percent || 0) + '%';
        progressText.textContent = text || '';
      }

      function hideProgress() {
        progressArea.classList.add('hidden');
        progressBar.style.width = '0';
      }

      function renderResult(pages) {
        if (!pages || pages.length === 0) {
          contentList.innerHTML = '<p class="text-gray-400 text-xs py-4 text-center">ç„¡è§£æå…§å®¹</p>';
          return;
        }
        var html = '';
        for (var p = 0; p < pages.length; p++) {
          var page = pages[p];
          var pageNum = page.page != null ? page.page : (page.page_number != null ? page.page_number : (p + 1));
          html += '<div class="rounded border border-gray-200 bg-gray-50 p-2">';
          html += '<div class="text-gray-500 text-xs font-medium mb-1">ç¬¬ ' + pageNum + ' é </div>';
          var elements = page.elements || (page.associated_text != null ? [{ type: 'text', content: page.associated_text, description: page.visual_summary || '' }] : []);
          for (var i = 0; i < elements.length; i++) {
            var el = elements[i];
            var type = el.type === 'image' ? 'image' : 'text';
            html += '<div class="text-xs mt-1 p-1.5 rounded bg-white border border-gray-100">';
            html += '<span class="text-gray-400">' + (type === 'image' ? 'åœ–' : 'æ–‡') + '</span> ';
            if (el.description) html += '<span class="text-gray-600">' + escapeHtml(el.description) + '</span>';
            if (el.content && type === 'text') html += '<div class="mt-0.5 text-gray-700 break-words">' + escapeHtml((el.content || '').slice(0, 200)) + (el.content.length > 200 ? 'â€¦' : '') + '</div>';
            html += '</div>';
          }
          html += '</div>';
        }
        contentList.innerHTML = html;
      }

      function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      btnUpload.addEventListener('click', function () {
        fileInput.click();
      });

      fileInput.addEventListener('change', function () {
        var file = fileInput.files[0];
        if (!file) return;
        if (file.type !== 'application/pdf') {
          progressText.textContent = 'è«‹é¸æ“‡ PDF æª”æ¡ˆ';
          setProgress(0, 'è«‹é¸æ“‡ PDF æª”æ¡ˆ');
          return;
        }

        setProgress(10, 'æ­£åœ¨è®€å–æª”æ¡ˆ...');
        var reader = new FileReader();
        reader.onload = function () {
          var dataUrl = reader.result;
          var base64 = dataUrl.indexOf(',') >= 0 ? dataUrl.split(',')[1] : dataUrl;
          if (!base64) {
            setProgress(0, 'è®€å–å¤±æ•—');
            return;
          }
          setProgress(30, 'æ­£åœ¨ä¸Šå‚³é›²ç«¯...');
          google.script.run
            .withSuccessHandler(function (uploaded) {
              setProgress(60, 'AI æ·±åº¦è§£æä¸­...');
              google.script.run
                .withSuccessHandler(function (result) {
                  setProgress(100, 'å®Œæˆ');
                  if (result.success) {
                    renderResult(result.pages);
                    progressText.textContent = 'å®Œæˆ Â· å…± ' + (result.count || 0) + ' é ';
                  } else {
                    contentList.innerHTML = '<p class="text-red-600 text-xs py-2">' + escapeHtml(result.error || 'è§£æå¤±æ•—') + '</p>';
                    progressText.textContent = 'è§£æå¤±æ•—';
                  }
                  setTimeout(hideProgress, 1500);
                })
                .withFailureHandler(function (err) {
                  contentList.innerHTML = '<p class="text-red-600 text-xs py-2">' + escapeHtml(err.message || String(err)) + '</p>';
                  progressText.textContent = 'è§£æå¤±æ•—';
                  setTimeout(hideProgress, 2000);
                })
                .callGcfParse(uploaded.bucket, uploaded.objectName);
            })
            .withFailureHandler(function (err) {
              contentList.innerHTML = '<p class="text-red-600 text-xs py-2">ä¸Šå‚³å¤±æ•—ï¼š' + escapeHtml(err.message || String(err)) + '</p>';
              progressText.textContent = 'ä¸Šå‚³å¤±æ•—';
              setTimeout(hideProgress, 2000);
            })
            .uploadToGcs(base64, file.name);
        };
        reader.onerror = function () {
          setProgress(0, 'è®€å–æª”æ¡ˆå¤±æ•—');
        };
        reader.readAsDataURL(file);
        fileInput.value = '';
      });
    })();
  </script>
</body>
</html>
